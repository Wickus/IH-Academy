<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ItsHappening.Africa - Sports Academy Management</title>
    
    <!-- Push Notification Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then((registration) => {
              console.log('SW registered: ', registration);
            })
            .catch((registrationError) => {
              console.log('SW registration failed: ', registrationError);
            });
        });
      }
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
    
    <!-- Service Worker for Push Notifications -->
    <script>
      // Inline service worker for push notifications
      if ('serviceWorker' in navigator && 'PushManager' in window) {
        const swCode = `
          self.addEventListener('install', (event) => {
            console.log('Service Worker installing');
            self.skipWaiting();
          });

          self.addEventListener('activate', (event) => {
            console.log('Service Worker activating');
            event.waitUntil(self.clients.claim());
          });

          self.addEventListener('push', (event) => {
            console.log('Push message received:', event);

            if (!event.data) {
              return;
            }

            let data;
            try {
              data = event.data.json();
            } catch (e) {
              data = {
                title: 'ItsHappening.Africa',
                body: event.data.text() || 'New notification',
                icon: '/vite.svg',
                badge: '/vite.svg'
              };
            }

            const options = {
              body: data.body,
              icon: data.icon || '/vite.svg',
              badge: data.badge || '/vite.svg',
              vibrate: [200, 100, 200],
              data: data.data || {},
              actions: data.actions || [],
              requireInteraction: true,
              tag: data.tag || 'default'
            };

            event.waitUntil(
              self.registration.showNotification(data.title, options)
            );
          });

          self.addEventListener('notificationclick', (event) => {
            console.log('Notification clicked:', event);
            
            event.notification.close();

            const action = event.action;
            const data = event.notification.data;

            let url = '/';
            
            if (data.type === 'class_reminder') {
              url = '/bookings';
            } else if (data.type === 'new_booking') {
              url = '/bookings';
            } else if (data.type === 'attendance_reminder') {
              url = '/classes';
            } else if (data.type === 'payment_reminder') {
              url = '/payments';
            }

            if (action === 'view') {
              url = '/bookings';
            } else if (action === 'mark') {
              url = '/classes';
            } else if (action === 'pay') {
              url = '/payments';
            }

            event.waitUntil(
              clients.matchAll({ type: 'window' }).then((clientList) => {
                for (const client of clientList) {
                  if (client.url.includes(url) && 'focus' in client) {
                    return client.focus();
                  }
                }
                
                if (clients.openWindow) {
                  return clients.openWindow(url);
                }
              })
            );
          });
        `;

        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('Push notification service worker registered');
          })
          .catch(error => {
            console.error('Failed to register service worker:', error);
          });
      }
    </script>
  </body>
</html>